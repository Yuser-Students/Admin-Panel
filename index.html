<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… ÙŠÙØ³Ø± - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <style>
    body { font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f6f7fb; }
    .login-card { max-width:420px; margin:auto; margin-top:6vh; }
    .table-wrap { max-height:60vh; overflow:auto; }
    .cursor-pointer { cursor:pointer; }
    .required { color:#d9534f; }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Login Card -->
    <div id="loginCard" class="card login-card shadow-sm">
      <div class="card-body">
        <h4 class="card-title text-center mb-2">Ù†Ø¸Ø§Ù… ÙŠÙØ³Ø±</h4>
        <p class="text-center text-muted mb-4">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</p>

        <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>

        <form id="loginForm" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="username" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="required">*</span></label>
            <input id="username" class="form-control" required />
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="required">*</span></label>
            <input id="password" type="password" class="form-control" required />
          </div>

          <div class="d-grid">
            <button id="loginBtn" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
          </div>
        </form>

        <hr />

        <div class="text-center text-muted small">
          Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: <code>admin</code> â€” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <code>yusur2025</code>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="d-none">

      <nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded-3 mb-3">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1">ğŸ‘©â€ğŸ’¼ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±Ø© - Ù†Ø¸Ø§Ù… ÙŠÙØ³Ø±</span>
          <div class="d-flex gap-2">
            <button id="refreshBtn" class="btn btn-light btn-sm">ØªØ­Ø¯ÙŠØ«</button>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </nav>

      <div class="row mb-3">
        <div class="col-md-3 mb-2">
          <div class="card p-3 shadow-sm">
            <div class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div id="totalCount" class="h4 m-0">0</div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card p-3 shadow-sm">
            <div class="text-muted">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            <div id="pendingCount" class="h4 m-0">0</div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card p-3 shadow-sm">
            <div class="text-muted">Ù…Ù‚Ø¨ÙˆÙ„</div>
            <div id="approvedCount" class="h4 m-0">0</div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card p-3 shadow-sm">
            <div class="text-muted">Ù…Ø±ÙÙˆØ¶</div>
            <div id="rejectedCount" class="h4 m-0">0</div>
          </div>
        </div>
      </div>

      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-4">
              <input id="searchInput" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©..." />
            </div>
            <div class="col-md-3">
              <select id="statusFilter" class="form-select">
                <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="gradeFilter" class="form-select">
                <option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
              </select>
            </div>
            <div class="col-md-2 text-end">
              <button id="demoBtn" class="btn btn-outline-secondary">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body table-wrap">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-primary">
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„ÙØµÙ„</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="excusesBody">
              <tr><td colspan="10" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Approve/Reject Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 id="actionModalTitle" class="modal-title">ØªØ£ÙƒÙŠØ¯</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="actionInfo" class="mb-3"></div>
            <div class="mb-2">
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±Ø© <span class="required">*</span></label>
              <textarea id="actionReply" class="form-control" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±Ø©..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="actionCancel" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="actionConfirm" type="button" class="btn btn-success">ØªØ£ÙƒÙŠØ¯</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap 5 JS + Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * ØºÙŠÙ‘Ø± Ù‡Ù†Ø§ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Web App (Google Apps Script) Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
     * Ù…Ø«Ø§Ù„: 'https://script.google.com/macros/s/AKfycbxxxxx/exec'
     */
    const API_URL = 'https://script.google.com/macros/s/AKfycbzBvleOrrpqR6YDn_Wq-jOCqdXE5tI93erJlMBqbZGEvjqxdF1IY40TxBkF9_At6jzCsw/exec';

    // DOM
    const loginCard = document.getElementById('loginCard');
    const loginForm = document.getElementById('loginForm');
    const loginAlert = document.getElementById('loginAlert');
    const loginBtn = document.getElementById('loginBtn');

    const dashboard = document.getElementById('dashboard');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const demoBtn = document.getElementById('demoBtn');

    const totalCount = document.getElementById('totalCount');
    const pendingCount = document.getElementById('pendingCount');
    const approvedCount = document.getElementById('approvedCount');
    const rejectedCount = document.getElementById('rejectedCount');

    const excusesBody = document.getElementById('excusesBody');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const gradeFilter = document.getElementById('gradeFilter');

    // modals
    const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));
    const actionModalEl = document.getElementById('actionModal');
    const actionModal = new bootstrap.Modal(actionModalEl);
    const actionModalTitle = document.getElementById('actionModalTitle');
    const actionInfo = document.getElementById('actionInfo');
    const actionReply = document.getElementById('actionReply');
    const actionConfirm = document.getElementById('actionConfirm');

    // state
    let allExcuses = [];
    let currentAction = null; // { type: 'approve'|'reject', excuse: {...} }

    // ---- Helper: call API ----
    async function callApi(payload) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        return json;
      } catch (err) {
        console.error('API call error', err);
        return { success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API' };
      }
    }

    // ---- Login ----
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginAlert.classList.add('d-none');

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        loginAlert.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        loginAlert.classList.remove('d-none');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

      const result = await callApi({ action: 'adminLogin', username, password });

      loginBtn.disabled = false;
      loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';

      if (result.success) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        loginCard.classList.add('d-none');
        dashboard.classList.remove('d-none');
        await loadAllData();
      } else {
        loginAlert.textContent = result.message || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        loginAlert.classList.remove('d-none');
      }
    });

    // if already logged
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
      loginCard.classList.add('d-none');
      dashboard.classList.remove('d-none');
      loadAllData().catch(()=>{});
    }

    // ---- Load data ----
    async function loadAllData() {
      await Promise.all([loadStatistics(), loadExcuses()]);
    }

    async function loadStatistics() {
      const res = await callApi({ action: 'getStatistics' });
      if (res.success) {
        totalCount.textContent = res.data.total;
        pendingCount.textContent = res.data.pending;
        approvedCount.textContent = res.data.approved;
        rejectedCount.textContent = res.data.rejected;
      }
    }

    async function loadExcuses() {
      const res = await callApi({ action: 'getAllExcuses' });
      if (!res.success) {
        alert(res.message || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        return;
      }
      allExcuses = res.data || [];
      populateGradeFilter();
      renderTable(allExcuses);
    }

    function populateGradeFilter() {
      const grades = Array.from(new Set(allExcuses.map(i => i.grade).filter(Boolean)));
      gradeFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>';
      grades.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g; opt.textContent = g;
        gradeFilter.appendChild(opt);
      });
    }

    // ---- Render table ----
    function renderTable(list) {
      if (!list || list.length === 0) {
        excusesBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
        return;
      }

      excusesBody.innerHTML = list.map(excuse => {
        const statusBadge = excuse.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'badge bg-warning text-dark' :
                            excuse.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'badge bg-success' : 'badge bg-danger';

        // protect quotes in JSON for inline handlers
        const json = JSON.stringify(excuse).replace(/"/g, '&quot;');

        return `
          <tr>
            <td>${escapeHtml(excuse.studentId || '')}</td>
            <td>${escapeHtml(excuse.studentName || '')}</td>
            <td>${escapeHtml(excuse.grade || '')}</td>
            <td>${escapeHtml(excuse.class || '')}</td>
            <td>${escapeHtml('' + (excuse.excuseNumber ?? ''))}</td>
            <td>${escapeHtml(excuse.excuseDate || '')}</td>
            <td>${escapeHtml(excuse.excuseTime || '')}</td>
            <td title="${escapeHtml(excuse.reason || '')}">${escapeHtml((excuse.reason || '').substring(0,30))}${(excuse.reason||'').length>30? '...':''}</td>
            <td><span class="${statusBadge}">${escapeHtml(excuse.status || '')}</span></td>
            <td>
              <div class="btn-group" role="group" aria-label="actions">
                <button class="btn btn-sm btn-outline-primary" onclick='view(${json})'>Ø¹Ø±Ø¶</button>
                ${(excuse.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') ? `
                  <button class="btn btn-sm btn-success" onclick='startAction("approve", ${json})'>Ù…ÙˆØ§ÙÙ‚Ø©</button>
                  <button class="btn btn-sm btn-danger" onclick='startAction("reject", ${json})'>Ø±ÙØ¶</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // escape helper
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ---- View single excuse ----
    function view(excuse) {
      const body = document.getElementById('viewModalBody');
      body.innerHTML = `
        <div class="mb-2"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(excuse.studentName||'')}</div>
        <div class="mb-2"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</strong> ${escapeHtml(excuse.studentId||'')}</div>
        <div class="mb-2"><strong>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„:</strong> ${escapeHtml(excuse.grade||'')} / ${escapeHtml(excuse.class||'')}</div>
        <div class="mb-2"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†:</strong> ${escapeHtml(excuse.excuseDate||'')}</div>
        <div class="mb-2"><strong>ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†:</strong> ${escapeHtml(excuse.excuseTime||'')}</div>
        <div class="mb-2"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong><br/> ${escapeHtml(excuse.reason||'')}</div>
        <div class="mb-2"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (WhatsApp):</strong> ${escapeHtml(excuse.whatsappStatus||'')}</div>
        ${excuse.reply ? `<div class="mb-2"><strong>Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±Ø©:</strong><br/> ${escapeHtml(excuse.reply)}</div>` : ''}
        ${excuse.replyDate ? `<div class="mb-2"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯:</strong> ${escapeHtml(excuse.replyDate)}</div>` : ''}
      `;
      viewModal.show();
    }

    // ---- Start approve/reject flow ----
    function startAction(type, excuse) {
      currentAction = { type, excuse };
      actionReply.value = '';
      actionInfo.innerHTML = `
        <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(excuse.studentName||'')}</div>
        <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</strong> ${escapeHtml(excuse.studentId||'')}</div>
        <div><strong>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„:</strong> ${escapeHtml(excuse.grade||'')} / ${escapeHtml(excuse.class||'')}</div>
        <div><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${escapeHtml((excuse.reason||'').substring(0,200))}</div>
      `;
      actionModalTitle.textContent = (type === 'approve') ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶';
      actionConfirm.classList.toggle('btn-success', type === 'approve');
      actionConfirm.classList.toggle('btn-danger', type === 'reject');
      actionConfirm.textContent = (type === 'approve') ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶';
      actionModal.show();
    }

    // ---- Confirm approve/reject ----
    actionConfirm.addEventListener('click', async () => {
      const reply = actionReply.value.trim();
      if (!reply) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.');
        return;
      }

      if (!currentAction || !currentAction.excuse) return;

      const rowIndex = currentAction.excuse.rowIndex;
      const status = currentAction.type === 'approve' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ù…Ø±ÙÙˆØ¶';

      // disable button
      actionConfirm.disabled = true;
      actionConfirm.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';

      // call API to update sheet
      const res = await callApi({
        action: 'updateExcuseStatus',
        rowIndex: rowIndex,
        status: status,
        reply: reply
      });

      actionConfirm.disabled = false;
      actionConfirm.textContent = (currentAction.type === 'approve') ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶';

      if (res.success) {
        // update UI local copy (refresh from server is safer but to be snappy update locally then reload)
        const idx = allExcuses.findIndex(e => e.rowIndex === rowIndex);
        if (idx !== -1) {
          allExcuses[idx].status = status;
          allExcuses[idx].reply = reply;
          // set replyDate to now (formatted)
          allExcuses[idx].replyDate = new Date().toLocaleString('ar-EG');
        }

        renderTable(applyFilters());
        await loadStatistics();
        actionModal.hide();
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
      } else {
        alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + (res.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
      }
    });

    // ---- Filters & helpers ----
    function applyFilters() {
      const search = (searchInput.value || '').trim().toLowerCase();
      const status = statusFilter.value;
      const grade = gradeFilter.value;

      return allExcuses.filter(e => {
        const matchesSearch = !search ||
          (e.studentName && e.studentName.toLowerCase().includes(search)) ||
          (e.studentId && (''+e.studentId).toLowerCase().includes(search));

        const matchesStatus = !status || e.status === status;
        const matchesGrade = !grade || e.grade === grade;

        return matchesSearch && matchesStatus && matchesGrade;
      });
    }

    searchInput.addEventListener('input', () => {
      renderTable(applyFilters());
    });

    statusFilter.addEventListener('change', () => {
      renderTable(applyFilters());
    });

    gradeFilter.addEventListener('change', () => {
      renderTable(applyFilters());
    });

    refreshBtn.addEventListener('click', async () => {
      await loadAllData();
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('adminLoggedIn');
      location.reload();
    });

    // demo data for testing without API
    demoBtn.addEventListener('click', () => {
      allExcuses = [
        {
          rowIndex: 2, studentId: '2024001', studentName: 'Ù†ÙˆØ±Ø© Ø£Ø­Ù…Ø¯', grade: 'Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', class: 'Ø£',
          excuseNumber: 1, excuseDate: '2025-11-05', excuseTime: '09:00', reason: 'Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ', status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', whatsappStatus: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', reply:'', replyDate:'', totalExcuses:1
        },
        {
          rowIndex: 3, studentId: '2024002', studentName: 'Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯', grade: 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', class: 'Ø¨',
          excuseNumber: 2, excuseDate: '2025-11-04', excuseTime: '10:30', reason: 'Ø¸Ø±Ù Ø¹Ø§Ø¦Ù„ÙŠ', status: 'Ù…Ù‚Ø¨ÙˆÙ„', whatsappStatus: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', reply:'ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', replyDate:'2025-11-03 14:30', totalExcuses:2
        }
      ];
      populateGradeFilter();
      renderTable(allExcuses);
      loadStatistics();
    });

    // small utility: if API unreachable show message
    (async function checkApi() {
      // optional quick ping (non-blocking)
      try {
        const res = await callApi({ action: 'getStatistics' });
        if (!res.success) {
          console.warn('API ping failed:', res.message);
        }
      } catch (e) {
        console.warn('API ping error', e);
      }
    })();

  </script>
</body>
</html>
