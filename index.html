<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… ÙŠÙØ³Ø± - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© (ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <style>
    body { font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f6fb; }
    .center-card { max-width:1100px; margin:28px auto; }
    .hide { display:none !important; }
    .status-badge { padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px; display:inline-block; }
    .status-pending { background:#fff4e5; color:#a65b00; border:1px solid #ffdca8; }
    .status-approved { background:#e6ffef; color:#065f46; border:1px solid #b7f3d0; }
    .status-rejected { background:#fff0f0; color:#9b1c1c; border:1px solid #f5c2c2; }
    pre.debug { max-height:200px; overflow:auto; background:#00000009; padding:10px; border-radius:6px; }
  </style>
</head>
<body>

<div class="container center-card">

  <!-- Header -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex align-items-center gap-3">
      <img src="" alt="logo" onerror="this.style.display='none'" style="width:76px;height:76px;border-radius:10px;object-fit:cover">
      <div>
        <h4 class="mb-0">Ù†Ø¸Ø§Ù… ÙŠÙØ³Ø±</h4>
        <small class="text-muted">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±Ø© â€” ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© (ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</small>
      </div>
    </div>
  </div>

  <!-- Login Card -->
  <div id="loginCard" class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</h5>

      <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>

      <form id="loginForm" class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUsername" class="form-control" autocomplete="username" required value="admin">
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPassword" type="password" class="form-control" autocomplete="current-password" required value="yusur2025">
        </div>

        <div class="col-12 d-flex gap-2">
          <button id="loginBtn" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
          <button id="demoBtn" type="button" class="btn btn-outline-secondary">ØªØ¬Ø±Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ¶ÙŠØ­ÙŠØ©</button>
          <div class="ms-auto">
            <small class="text-muted">Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø«Ù… Ø§Ø¶ØºØ· "Ø¯Ø®ÙˆÙ„"</small>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Dashboard Card -->
  <div id="dashboardCard" class="card shadow-sm hide">
    <div class="card-body">
      <div class="d-flex align-items-start mb-3 gap-3">
        <div>
          <h5 class="mb-0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</h5>
          <small class="text-muted">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø§Øª Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</small>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-primary btn-sm">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <!-- stats -->
      <div class="row g-2 mb-3">
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center bg-white">
            <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div id="statTotal" class="fw-bold fs-4">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center bg-white">
            <div class="text-muted small">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            <div id="statPending" class="fw-bold fs-4 text-warning">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center bg-white">
            <div class="text-muted small">Ù…Ù‚Ø¨ÙˆÙ„</div>
            <div id="statApproved" class="fw-bold fs-4 text-success">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center bg-white">
            <div class="text-muted small">Ù…Ø±ÙÙˆØ¶</div>
            <div id="statRejected" class="fw-bold fs-4 text-danger">0</div>
          </div>
        </div>
      </div>

      <!-- filters -->
      <div class="row g-2 align-items-center mb-3">
        <div class="col-12 col-md-4">
          <input id="searchInput" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†">
        </div>
        <div class="col-6 col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <select id="gradeFilter" class="form-select">
            <option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
          </select>
        </div>
        <div class="col-12 col-md-2 text-start">
          <small id="lastUpdated" class="text-muted"></small>
        </div>
      </div>

      <!-- table -->
      <div class="table-responsive mb-3">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ØµÙ</th>
              <th>Ø§Ù„ÙØµÙ„</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø³Ø¨Ø¨</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="excusesTbody">
            <tr><td colspan="10" class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>
          </tbody>
        </table>
      </div>

      <div id="actionAlert" class="alert d-none" role="alert"></div>

      <!-- modal view / approve / reject -->
      <div class="modal fade" id="excuseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 id="modalTitle" class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
            <div class="modal-body">
              <div id="modalBodyContent"></div>

              <div id="modalReplyGroup" class="mt-3 hide">
                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</label>
                <textarea id="modalReply" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ Ø§Ù„Ø±ÙØ¶)"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button id="modalRejectBtn" type="button" class="btn btn-danger">Ø±ÙØ¶</button>
              <button id="modalApproveBtn" type="button" class="btn btn-success">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- debug area (hidden by default) -->
  <div id="debugBox" class="mt-3 d-none">
    <h6>Debug</h6>
    <pre id="debugPre" class="debug"></pre>
  </div>

</div>

<!-- Bootstrap & dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/*
  Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App URL (Ù†ÙØ´Ø± ÙƒÙ€ "Anyone, even anonymous" Ø£Ùˆ Ø¨Ù…Ø§ ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ)
  Ù…Ø«Ø§Ù„: const API_URL = 'https://script.google.com/macros/s/AKfycb.../exec';
*/
const API_URL = 'https://script.google.com/macros/s/AKfycbzBvleOrrpqR6YDn_Wq-jOCqdXE5tI93erJlMBqbZGEvjqxdF1IY40TxBkF9_At6jzCsw/exec'; // <-- ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

// Ø¹Ù†Ø§ØµØ± DOM
const loginCard = document.getElementById('loginCard');
const dashboardCard = document.getElementById('dashboardCard');
const loginForm = document.getElementById('loginForm');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginAlert = document.getElementById('loginAlert');

const logoutBtn = document.getElementById('logoutBtn');
const refreshBtn = document.getElementById('refreshBtn');
const excusesTbody = document.getElementById('excusesTbody');
const statTotal = document.getElementById('statTotal');
const statPending = document.getElementById('statPending');
const statApproved = document.getElementById('statApproved');
const statRejected = document.getElementById('statRejected');
const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');
const gradeFilter = document.getElementById('gradeFilter');
const lastUpdated = document.getElementById('lastUpdated');
const actionAlert = document.getElementById('actionAlert');

const excuseModal = new bootstrap.Modal(document.getElementById('excuseModal'));
const modalTitle = document.getElementById('modalTitle');
const modalBodyContent = document.getElementById('modalBodyContent');
const modalReplyGroup = document.getElementById('modalReplyGroup');
const modalReply = document.getElementById('modalReply');
const modalApproveBtn = document.getElementById('modalApproveBtn');
const modalRejectBtn = document.getElementById('modalRejectBtn');

let allExcuses = [];
let currentExcuse = null;

// Helpers
function showLoginError(msg) {
  loginAlert.textContent = msg;
  loginAlert.classList.remove('d-none');
}
function hideLoginError() {
  loginAlert.classList.add('d-none');
}
function showActionAlert(msg, type='success') {
  actionAlert.className = 'alert';
  actionAlert.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
  actionAlert.textContent = msg;
  actionAlert.classList.remove('d-none');
  setTimeout(() => actionAlert.classList.add('d-none'), 4000);
}
function debug(obj) {
  // uncomment if you need debug area
  // document.getElementById('debugPre').textContent = JSON.stringify(obj, null, 2);
  // document.getElementById('debugBox').classList.remove('d-none');
}

// Fetch wrapper
async function apiPost(payload) {
  if (!API_URL || API_URL.includes('https://script.google.com/macros/s/AKfycbzBvleOrrpqR6YDn_Wq-jOCqdXE5tI93erJlMBqbZGEvjqxdF1IY40TxBkF9_At6jzCsw/exec')) {
    throw new Error('API_URL ØºÙŠØ± Ù…ÙØ¹Ø¯ â€” Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (API_URL).');
  }
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  return res.json();
}

// Login action
loginForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  hideLoginError();
  loginBtn.disabled = true;
  loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  try {
    const result = await apiPost({ action: 'adminLogin', username, password });
    if (result && result.success) {
      // show dashboard
      loginCard.classList.add('hide');
      dashboardCard.classList.remove('hide');
      await loadAllData();
    } else {
      showLoginError(result.message || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    }
  } catch (err) {
    showLoginError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡. ' + (err.message || ''));
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
  }
});

// demo data button (local demo)
demoBtn.addEventListener('click', () => {
  loginCard.classList.add('hide');
  dashboardCard.classList.remove('hide');
  loadDemoData();
});

// Logout
logoutBtn.addEventListener('click', () => {
  dashboardCard.classList.add('hide');
  loginCard.classList.remove('hide');
});

// Refresh
refreshBtn.addEventListener('click', loadAllData);

// Search / filters
searchInput.addEventListener('input', () => renderTable(getFilteredExcuses()));
statusFilter.addEventListener('change', () => renderTable(getFilteredExcuses()));
gradeFilter.addEventListener('change', () => renderTable(getFilteredExcuses()));

// Load all data
async function loadAllData() {
  try {
    const resp = await apiPost({ action: 'getAllExcuses' });
    if (!resp || !resp.success) {
      throw new Error(resp ? resp.message : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
    allExcuses = resp.data || [];
    populateGradeFilter();
    renderTable(allExcuses);
    updateStats();
    lastUpdated.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date().toLocaleString('ar-EG');
  } catch (err) {
    showActionAlert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (err.message || ''), 'danger');
    // fall back: keep previous data
  }
}

function loadDemoData() {
  allExcuses = [
    { rowIndex:2, studentId:'2024001', studentName:'Ù†ÙˆØ±Ø© Ø£Ø­Ù…Ø¯', grade:'Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', class:'Ø£', civilId:'1234567890', senderPhone:'+966500111222', excuseNumber:1, excuseDate:'2025-11-05', excuseTime:'09:00', reason:'Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ', status:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', reply:'', replyDate:'', whatsappStatus:'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', totalExcuses:1 },
    { rowIndex:3, studentId:'2024002', studentName:'Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯', grade:'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', class:'Ø¨', civilId:'9876543210', senderPhone:'+201001234567', excuseNumber:2, excuseDate:'2025-11-04', excuseTime:'10:30', reason:'Ø¸Ø±Ù Ø¹Ø§Ø¦Ù„ÙŠ', status:'Ù…Ù‚Ø¨ÙˆÙ„', reply:'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', replyDate:'2025-11-03 14:30:00', whatsappStatus:'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', totalExcuses:2 }
  ];
  populateGradeFilter();
  renderTable(allExcuses);
  updateStats();
  lastUpdated.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ¶ÙŠØ­ÙŠØ©';
}

// create table rows
function renderTable(data) {
  const arr = data || [];
  if (!arr.length) {
    excusesTbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
    return;
  }

  excusesTbody.innerHTML = arr.map(ex => {
    const statusClass = ex.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'status-pending' : (ex.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'status-approved' : 'status-rejected');
    const shortReason = ex.reason ? (ex.reason.length > 30 ? ex.reason.slice(0,30) + '...' : ex.reason) : '';
    // escape values for onclick JSON
    const payload = encodeURIComponent(JSON.stringify(ex));
    return `
      <tr>
        <td>${escapeHtml(ex.studentId || '')}</td>
        <td>${escapeHtml(ex.studentName || '')}</td>
        <td>${escapeHtml(ex.grade || '')}</td>
        <td>${escapeHtml(ex.class || '')}</td>
        <td>${escapeHtml(String(ex.excuseNumber || ''))}</td>
        <td>${escapeHtml(ex.excuseDate || '')}</td>
        <td>${escapeHtml(ex.excuseTime || '')}</td>
        <td title="${escapeHtml(ex.reason || '')}">${escapeHtml(shortReason)}</td>
        <td><span class="status-badge ${statusClass}">${escapeHtml(ex.status || '')}</span></td>
        <td>
          <div class="btn-group" role="group" aria-label="actions">
            <button class="btn btn-sm btn-outline-primary" onclick="onViewClick('${payload}')">Ø¹Ø±Ø¶</button>
            ${ex.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? `<button class="btn btn-sm btn-success" onclick="onApproveClick('${payload}')">âœ…</button>
            <button class="btn btn-sm btn-danger" onclick="onRejectClick('${payload}')">âŒ</button>` : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// helpers for escaping
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
}

// filters
function getFilteredExcuses() {
  const s = (searchInput.value || '').trim().toLowerCase();
  const status = statusFilter.value;
  const grade = gradeFilter.value;
  return allExcuses.filter(ex => {
    let match = true;
    if (s) {
      match = (String(ex.studentName||'').toLowerCase().includes(s) ||
               String(ex.studentId||'').toLowerCase().includes(s) ||
               String(ex.excuseNumber||'').toLowerCase().includes(s) );
    }
    if (match && status) match = ex.status === status;
    if (match && grade) match = ex.grade === grade;
    return match;
  });
}

// populate grade filter
function populateGradeFilter() {
  const set = new Set(allExcuses.map(e => e.grade).filter(Boolean));
  gradeFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>' + Array.from(set).map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
}

// update stats
function updateStats() {
  statTotal.textContent = allExcuses.length;
  statPending.textContent = allExcuses.filter(e => e.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©').length;
  statApproved.textContent = allExcuses.filter(e => e.status === 'Ù…Ù‚Ø¨ÙˆÙ„').length;
  statRejected.textContent = allExcuses.filter(e => e.status === 'Ù…Ø±ÙÙˆØ¶').length;
}

// modal actions
window.onViewClick = function(payloadEncoded) {
  const ex = JSON.parse(decodeURIComponent(payloadEncoded));
  currentExcuse = ex;
  modalTitle.textContent = `Ø§Ø³ØªØ¦Ø°Ø§Ù† Ø±Ù‚Ù… ${ex.excuseNumber} â€” ${ex.studentName}`;
  modalBodyContent.innerHTML = getModalContentHtml(ex);
  modalReply.value = ex.reply || '';
  modalReplyGroup.classList.add('hide');
  modalApproveBtn.classList.remove('d-none');
  modalRejectBtn.classList.remove('d-none');
  excuseModal.show();
};

window.onApproveClick = function(payloadEncoded) {
  const ex = JSON.parse(decodeURIComponent(payloadEncoded));
  currentExcuse = ex;
  modalTitle.textContent = `Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù† â€” ${ex.studentName}`;
  modalBodyContent.innerHTML = getModalContentHtml(ex);
  modalReply.value = '';
  modalReplyGroup.classList.remove('hide');
  excuseModal.show();
  // set handlers
  modalApproveBtn.onclick = () => performUpdate('Ù…Ù‚Ø¨ÙˆÙ„');
  modalRejectBtn.onclick = null;
};

window.onRejectClick = function(payloadEncoded) {
  const ex = JSON.parse(decodeURIComponent(payloadEncoded));
  currentExcuse = ex;
  modalTitle.textContent = `Ø±ÙØ¶ Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù† â€” ${ex.studentName}`;
  modalBodyContent.innerHTML = getModalContentHtml(ex);
  modalReply.value = '';
  modalReplyGroup.classList.remove('hide');
  excuseModal.show();
  modalRejectBtn.onclick = () => performUpdate('Ù…Ø±ÙÙˆØ¶');
  modalApproveBtn.onclick = null;
};

function getModalContentHtml(ex) {
  return `
    <div class="row g-2">
      <div class="col-12 col-md-6"><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</strong> ${escapeHtml(ex.studentName||'')}</div>
      <div class="col-12 col-md-6"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</strong> ${escapeHtml(ex.studentId||'')}</div>
      <div class="col-12 col-md-6"><strong>Ø§Ù„ØµÙ / Ø§Ù„ÙØµÙ„:</strong> ${escapeHtml(ex.grade||'')} - ${escapeHtml(ex.class||'')}</div>
      <div class="col-12 col-md-6"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙØ±Ø³Ù„:</strong> ${escapeHtml(ex.senderPhone||'')}</div>
      <div class="col-12 col-md-6"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†:</strong> ${escapeHtml(ex.excuseDate||'')}</div>
      <div class="col-12 col-md-6"><strong>ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†:</strong> ${escapeHtml(ex.excuseTime||'')}</div>
      <div class="col-12"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong><div class="mt-1">${escapeHtml(ex.reason||'')}</div></div>
      <div class="col-12"><strong>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="status-badge ${ex.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'status-pending' : ex.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'status-approved' : 'status-rejected'}">${escapeHtml(ex.status || '')}</span></div>
      ${ex.reply ? `<div class="col-12"><strong>Ø±Ø¯ Ø³Ø§Ø¨Ù‚:</strong><div class="mt-1">${escapeHtml(ex.reply)}</div></div>` : ''}
    </div>
  `;
}

// perform update (approve/reject)
async function performUpdate(newStatus) {
  if (!currentExcuse) return;
  const replyText = modalReply.value.trim();
  if (!replyText) {
    alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©/Ø±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    return;
  }

  // disable buttons
  modalApproveBtn.disabled = true;
  modalRejectBtn.disabled = true;
  modalApproveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  modalRejectBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

  try {
    // call API
    const payload = {
      action: 'updateExcuseStatus',
      rowIndex: currentExcuse.rowIndex,
      status: newStatus,
      reply: replyText
    };
    const res = await apiPost(payload);
    if (!res || !res.success) {
      throw new Error(res ? res.message : 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    }

    // update local data (so UI updates instantly)
    const idx = allExcuses.findIndex(e => e.rowIndex === currentExcuse.rowIndex);
    if (idx !== -1) {
      allExcuses[idx].status = newStatus;
      allExcuses[idx].reply = replyText;
      allExcuses[idx].replyDate = new Date().toLocaleString('ar-EG');
      allExcuses[idx].whatsappStatus = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'; // or set as desired
    }

    renderTable(getFilteredExcuses());
    updateStats();
    excuseModal.hide();
    showActionAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
  } catch (err) {
    showActionAlert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + (err.message || ''), 'danger');
  } finally {
    modalApproveBtn.disabled = false;
    modalRejectBtn.disabled = false;
    modalApproveBtn.textContent = 'Ù…ÙˆØ§ÙÙ‚Ø©';
    modalRejectBtn.textContent = 'Ø±ÙØ¶';
  }
}

// initial - hide dashboard
dashboardCard.classList.add('hide');

</script>
</body>
</html>
